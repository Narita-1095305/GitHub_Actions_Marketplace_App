# 実装計画: フェーズ1 (MVP)

## 1. 現在の状況

- 基本的なプロジェクト構造のセットアップが完了しました。
- Goモジュール (`dep-risk`) とNext.jsアプリケーション (`dashboard`) が初期化されました。
- PostgreSQLとRedisのためのDocker Compose設定が準備できています。
- GitHub Actionのための`action.yml`と`Dockerfile`が設計書に基づいて作成されました。

## 2. 次の目標: CLIコア機能の実装

次のフェーズの主な目標は、GitHub Action内で実行される`dep-risk` CLIのコアロジックを実装することです。これには、依存関係のスキャン、脆弱性の分析、リスクスコアの計算が含まれます。

## 3. 詳細なタスク分割

### 3.1. 脆弱性スキャンエンジン (`internal/scanner`)

- **タスク:** 外部スキャンツールを実行するためのGoラッパーを作成します。
  - **詳細:** `syft`を実行してプロジェクトファイル (`go.mod`, `package-lock.json`) からSBOM (ソフトウェア部品表) を生成する関数を実装します。
  - **詳細:** 生成されたSBOMを入力として`osv-scanner`を実行し、JSON形式で脆弱性リストを取得する関数を実装します。
  - **受入条件:** Goの関数がリポジトリパスを受け取り、構造化された脆弱性リストを返すことができること。

### 3.2. リスクスコアリング (`internal/scorer`)

- **タスク:** リスクスコアリングアルゴリズムの初期バージョンを実装します。
  - **詳細:** `risk_scoring_algorithm_detailed.md`に基づき、単純な計算式を実装します:
    `リスクスコア = (CVSS × 0.7) + (人気度係数 × 0.2) + (依存関係の深さ × 0.1)`
  - **詳細:** MVPでは、「人気度係数」と「依存関係の深さ」は単純化またはモック（仮の値）で対応します。主な焦点はCVSSスコアです。
  - **受入条件:** 関数が脆弱性情報を受け取り、0から10の間のリスクスコアを返すことができること。

### 3.3. 設定ファイルの読み込み (`internal/config`)

- **タスク:** `.github/dep-risk.yml` 設定ファイルの読み込みを実装します。
  - **詳細:** `gopkg.in/yaml.v3`のようなライブラリを使用して、設定ファイルを解析します。
  - **詳細:** 読み込まれる設定には、`fail_threshold`、`warn_threshold`、`ignore`リストが含まれます。
  - **受入条件:** アプリケーションがYAML設定ファイルから設定を正しく読み込み、適用できること。

### 3.4. CLIエントリーポイント (`cmd/action/main.go`)

- **タスク:** 上記のコンポーネントをメインのCLIアプリケーションに統合します。
  - **詳細:** 環境変数からGitHub Actionsの入力 (`INPUT_FAIL_THRESHOLD`など) を読み取ります。
  - **詳細:** `設定読み込み` -> `スキャナ実行` -> `スコア計算` -> `しきい値との比較` というワークフローを編成します。
  - **詳細:** リスクがしきい値を下回る場合はステータスコード`0`で、超える場合は`1`で終了します。
  - **受入条件:** コンパイルされたGoアプリケーションがコマンドラインから実行でき、スキャンを実行し、正しいステータスコードで終了すること。

## 4. 開発プロセスと品質保証

- **単体テストの徹底:**
    - `internal` パッケージ内の各主要な機能について、対応する単体テスト (`_test.go` ファイル) を実装後に必ず作成します。
    - モックやスタブを活用し、外部依存性（ファイルシステム、外部コマンドの実行結果など）から隔離されたテストを記述します。
- **継続的なテスト実行:**
    - 各機能の実装完了後、ただちに `go test ./...` を実行し、すべてのテストがパスすることを確認します。
    - テストが失敗した場合は、次のタスクに進む前に必ず問題を修正します。このプロセスを徹底することで、品質を担保しながら開発を進めます。

## 5. 優先順位と集中すべき点

1.  **脆弱性スキャンエンジン:** コアとなるデータソースです。最優先。
2.  **CLIエントリーポイント:** 全体的なワークフローを構築するため。
3.  **リスクスコアリング:** スキャナからの生データを処理するため。
4.  **設定ファイルの読み込み:** CLIを柔軟にするため。

*この初期フェーズではコアとなる自己完結型のロジックに集中するため、GitHub APIとの連携（コメント投稿やチェックラン作成など）は次のフェーズで対応します。*
